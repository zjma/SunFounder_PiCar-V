<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MunyaCar</title>
    <style>
    .container {
        width: 80%;
        height: 80%;
        position: absolute;
        margin:auto;
        top:0;
        bottom:0;
        left:0;
        right:0;
        /* background-color: #aaa; */
    }

    .blinking {
      margin: 20% 45% 0;
      display:inline-block;

      font-size: 4em;

      border: 10px solid #9ae2ff;
      animation-name: blinking;
      animation-duration: 1s;
      animation-iteration-count: 100;
    }
    @keyframes blinking {
      50% {
        border-color: #ffcd5f;
      }
    }

    img#StreamView {
        height: auto;
        width: auto;
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        position: absolute;
        margin:auto;
        top:0;
        bottom:0;
        left:0;
        right:0;
    }

    .BotControlInactive {
        opacity: 0.3;
    }

    div#NavigationHint {
        height: auto;
        width: auto;
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        position: absolute;
        margin:auto;
        top:0;
        bottom:0;
        left:0;
        right:0;
    }
    </style>
</head>
<body>
    <div id="StatusDisplay">This is a message.</div>
    <div class="container">
        <img id="StreamView" class="BotControlInactive" draggable="false" src="http://10.0.0.4:8080/?action=stream" />
    </div>
    <script>

    var Misc = {
        W: false,
        A: false,
        S: false,
        D: false,
    };

    var TargetState = {
        TargetLeftWheelVelocity: 0.0,
        TargetRightWheelVelocity: 0.0,
        PanVelocity: 0.0,
        TiltVelocity: 0.0,
    };

    var BotStateShuttle = {
        SentRequestCount: 0,
        WaitingForResponse: false,
    };

    var Ui = {
        BotControlState: 'Disconnected',
    };

    function getZoneRelativeToStreamView(viewPortX,viewPortY){
        var streamViewRect = document.getElementById('StreamView').getBoundingClientRect();
        var colIdx = (viewPortX<streamViewRect.left)?0:(viewPortX>streamViewRect.right)?2:1;
        var rowIdx = (viewPortY<streamViewRect.top)?0:(viewPortY>streamViewRect.bottom)?2:1;
        return rowIdx*3+colIdx;
    }

    function resetTargetState() {
        TargetState.TargetLeftWheelVelocity = 0.0;
        TargetState.TargetRightWheelVelocity = 0.0;
        TargetState.PanVelocity = 0.0;
        TargetState.TiltVelocity = 0.0;
    }

    function handleBotStateShuttleLoadEnd(e) {
        BotStateShuttle.WaitingForResponse = false;
    }

    function handleBotStateShuttleTimeout(e) {
        console.warn(e);
        BotStateShuttle.WaitingForResponse = false;
    }

    function runTargetStateShuttleIteration() {
        if (!BotStateShuttle.WaitingForResponse && Ui.BotControlState == 'Connected') {
            var httpRequest = new XMLHttpRequest();
            httpRequest.timeout = 1000;
            httpRequest.addEventListener('loadend', handleBotStateShuttleLoadEnd);
            httpRequest.addEventListener('timeout', handleBotStateShuttleTimeout);
            httpRequest.open('POST', 'http://10.0.0.4:8002');
            httpRequest.setRequestHeader("Content-Type", "application/json");
            httpRequest.send(JSON.stringify(TargetState));
            console.log(Misc);
            console.log(TargetState);
            BotStateShuttle.SentRequestCount+=1;
            BotStateShuttle.WaitingForResponse = true;
        }
    }

    function updateTargetVelocity() {
        if (!Misc.W && Misc.A && Misc.S && !Misc.D) {
            TargetState.TargetLeftWheelVelocity = 0.0;
            TargetState.TargetRightWheelVelocity = -1.0;
        } else if (!Misc.W && !Misc.A && Misc.S && !Misc.D) {
            TargetState.TargetLeftWheelVelocity = -1.0;
            TargetState.TargetRightWheelVelocity = -1.0;
        } else if (!Misc.W && !Misc.A && Misc.S && Misc.D) {
            TargetState.TargetLeftWheelVelocity = -1.0;
            TargetState.TargetRightWheelVelocity = 0.0;
        } else if (!Misc.W && Misc.A && !Misc.S && !Misc.D) {
            TargetState.TargetLeftWheelVelocity = -1.0;
            TargetState.TargetRightWheelVelocity = 1.0;
        } else if (!Misc.W && !Misc.A && !Misc.S && Misc.D) {
            TargetState.TargetLeftWheelVelocity = 1.0;
            TargetState.TargetRightWheelVelocity = -1.0;
        } else if (Misc.W && Misc.A && !Misc.S && !Misc.D) {
            TargetState.TargetLeftWheelVelocity = 0.0;
            TargetState.TargetRightWheelVelocity = 1.0;
        } else if (Misc.W && !Misc.A && !Misc.S && !Misc.D) {
            TargetState.TargetLeftWheelVelocity = 1.0;
            TargetState.TargetRightWheelVelocity = 1.0;
        } else if (Misc.W && !Misc.A && !Misc.S && Misc.D) {
            TargetState.TargetLeftWheelVelocity = 1.0;
            TargetState.TargetRightWheelVelocity = 0.0;
        } else {
            TargetState.TargetLeftWheelVelocity = 0.0;
            TargetState.TargetRightWheelVelocity = 0.0;
        }
    }

    function goDisconnected() {
        Ui.BotControlState = "Disconnected";
        document.getElementById('StatusDisplay').innerHTML = 'Bot control offline. Click camera to connect.';
        resetTargetState();
        document.getElementById('StreamView').classList.add('BotControlInactive');
    }

    goDisconnected();

    setInterval(runTargetStateShuttleIteration, 50);

    function getDistance(x0, y0, x1, y1) {
        return Math.sqrt(Math.pow(x0-x1, 2) + Math.pow(y0-y1, 2));
    }

    document.addEventListener('mousemove', function(e){
        if (Ui.BotControlState == 'Connected'){
            var camera = document.getElementById('StreamView').getBoundingClientRect();
            var L2C=e.clientX-Math.max(e.clientX-camera.left,0);
            var C2R=window.innerWidth-e.clientX-Math.max(camera.right-e.clientX,0);
            var T2C=e.clientY-Math.max(e.clientY-camera.top,0);
            var C2B=window.innerHeight-e.clientY-Math.max(camera.bottom-e.clientY,0);
            TargetState.PanVelocity=1.0*(C2R-L2C)/window.innerWidth;
            TargetState.TiltVelocity=1.0*(C2B-T2C)/window.innerHeight;
        }
    });
    document.addEventListener('keydown', function(e){
        if (e.code=='KeyW') {
            Misc.W = true;
        } else if(e.code=='KeyA') {
            Misc.A = true;
        } else if(e.code=='KeyS') {
            Misc.S = true;
        } else if(e.code=='KeyD') {
            Misc.D = true;
        }

        if (Ui.BotControlState == 'Connected') {
            updateTargetVelocity();
        }
    });

    document.addEventListener('keyup', function(e){
        if (e.code=='KeyW') {
            Misc.W = false;
        } else if(e.code=='KeyA') {
            Misc.A = false;
        } else if(e.code=='KeyS') {
            Misc.S = false;
        } else if(e.code=='KeyD') {
            Misc.D = false;
        }

        if (Ui.BotControlState == 'Connected') {
            updateTargetVelocity();
        }
    });

    document.addEventListener('mouseup', function(e){
        if (e.button==0) {
            var camera = document.getElementById('StreamView')
            var cameraBox = camera.getBoundingClientRect();
            if (cameraBox.left <= e.clientX && e.clientX <= cameraBox.right && cameraBox.top <= e.clientY && e.clientY <= cameraBox.bottom) {
                if (Ui.BotControlState == 'Disconnected') {
                    Ui.BotControlState = 'Connected';
                    document.getElementById('StatusDisplay').innerHTML = 'Bot control online. Use W-A-S-D to drive. Move the cursor out of camera to look around. Click camera to disconnect.';
                    camera.classList.remove('BotControlInactive');
                    resetTargetState();
                } else if (Ui.BotControlState == 'Connected') {
                    goDisconnected();
                } else {
                    //Nothing to do.
                }
            }
        }
    });
    </script>
</body>
</html>
